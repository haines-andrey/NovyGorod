name: Web App/Build 

on:
  workflow_dispatch:
    inputs:
      build_version:
        type: string
        description: 'Version of web application, (major).(minor)'
        required: true
  push:
    tags: release/v*
    paths:
      - src
        
env:
  TAG_NAME: ${{ github.ref_name }}
  BUILD_VERSION: ${{ inputs.version }}

jobs:
  Job:
    runs-on: windows-latest
    steps:
      - name: Get build version
        run: echo "${ $env.TAG_NAME }"

      - name: Set build version from tag name
        if: ${{ env.BUILD_VERSION == null }}
        run: $Env:BUILD_VERSION = "${ TAG_NAME#v }"
        
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Setup node
        uses: actions/setup-node@v3

      - name: Build project
        run: dotnet build src/Presentation/NovyGorodAsp --configuration Release -p:Version=${ BUILD_VERSION }

      - name: Invoke NpmInstallAndMove.ps1
        run: .\scripts\NpmInstallAndMove.ps1

      - name: Publish artifact
        run: dotnet publish src/Presentation/NovyGorodAsp --output web-app --no-build --configuration Release

      - name: Upload artifact
        if: ${{ inputs.upload_artifacts }}
        uses: actions/upload-artifact@v3
        with:
          name: novy-gorod-web-app_${{ env.BUILD_VERSION }}
          path: web-app/**
          if-no-files-found: error